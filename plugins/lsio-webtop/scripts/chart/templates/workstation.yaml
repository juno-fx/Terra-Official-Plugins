apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: "{{ .Values.name }}"
  labels:
    kuiper.juno-innovations.com/workstation: "{{ .Values.name }}"


spec:
  replicas: 1

  selector:
    matchLabels:
      kuiper.juno-innovations.com/workstation: "{{ .Values.name }}"

  template:
    metadata:
      labels:
        kuiper.juno-innovations.com/workstation: "{{ .Values.name }}"
      annotations:
        # This will block the cluster autoscaler from evicting this pod in the case
        # it can move to a cheaper instance. This does come at a cost, but ideally
        # this should stop from a workstation getting ripped out from under existing users.
        cluster-autoscaler.kubernetes.io/safe-to-evict: "false"

    spec:
      automountServiceAccountToken: false
      hostname: "{{ .Values.name }}"

      {{- if .Values.selector }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  {{- range .Values.selector }}
                  - key: {{ .key | quote }}
                    operator: In
                    values:
                      - {{ .value | quote }}
                  {{- end }}
      {{- end }}

      {{- if .Values.gpu }}
      runtimeClassName: nvidia
      {{- end }}

      {{- if .Values.pullSecret }}
      imagePullSecrets:
        - name: "{{ .Values.pullSecret }}"
      {{- end }}

      containers:
        - name: webtop
          imagePullPolicy: IfNotPresent
          image: "{{ .Values.registry }}/{{ .Values.repo }}:{{ .Values.tag }}"
          resources:
            requests:
              memory: "{{ .Values.memory }}"
              cpu: "{{ .Values.cpu }}"
            # gotmpl's or is a function taking 2 args - this is "X or Y or Z" translated to python
            {{- if or (or .Values.gpu .Values.memoryLimit) .Values.cpuLimit }}
            limits:
            {{- if .Values.gpu }}
              nvidia.com/gpu: "1"
            {{- end }}
            {{- if .Values.cpuLimit }}
              cpu: "{{ .Values.cpuLimit }}"
            {{- end }}
            {{- if .Values.memoryLimit }}
              memory: "{{ .Values.memoryLimit }}"
            {{- end }}
            {{- end }}
          ports:
            - containerPort: 3001
              name: viewer
          env:
            - name: JUNO_WORKSTATION
              value: "{{ .Values.name }}"
            - name: JUNO_PROJECT
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: JUNO_ENVIRONMENT
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: PUID
              value: "{{ .Values.puid }}"
            - name: PGID
              value: "{{ .Values.guid }}"
            - name: SUBFOLDER
              value: "/polaris/{{ .Values.name }}/"
            - name: START_DOCKER
              value: "false"
            {{- range .Values.env }}
            - name: {{ .name | quote }}
              value: {{ .value | quote }}
            {{- end }}
          volumeMounts:
            - mountPath: /dev/shm
              name: dshm
            {{- if .Values.volumeMounts }}
            {{- toYaml .Values.volumeMounts | nindent 12 }}
            {{- end }}
            {{- if .Values.plugins }}
            {{- range .Values.plugins }}
            - name: {{ .name | quote }}
              subPath: {{ .file | quote }}
              mountPath: "/etc/helios/init.d/{{ .name }}/{{ .file }}"
            {{- end }}
            {{- end }}
      volumes:
        - name: dshm
          emptyDir:
            medium: Memory
        {{- if .Values.volumeMounts }}
        {{- toYaml .Values.volumes | nindent 8 }}
        {{- end }}
        {{- if .Values.plugins }}
        {{- range .Values.plugins }}
        - name: {{ .name | quote }}
          configMap:
            name: {{ .config | quote }}
            defaultMode: 0777
        {{- end }}
        {{- end }}

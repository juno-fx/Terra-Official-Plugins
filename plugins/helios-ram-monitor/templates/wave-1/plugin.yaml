apiVersion: v1
kind: ConfigMap
metadata:
  name: helios-ram-monitor
  labels:
    kuiper.juno-innovations.com/plugin: "true"
data:
  helios-ram-monitor.sh: |
    #!/bin/bash

    # Default threshold and interval
    THRESHOLD=${HELIOS_RAM_WARN:-2}
    INTERVAL=${HELIOS_RAM_WARN_INTERVAL:-5}

    # Function to check RAM usage and send notification
    check_ram_usage() {
        read -r _ total _ <<< "$(free -m | grep Mem)"
        read -r _ used _ <<< "$(free -m | grep Mem)"
        usage_percent=$(( used * 100 / total ))

        if [ "$usage_percent" -ge "$THRESHOLD" ]; then
            notify-send "⚠️ High RAM Usage" "RAM usage is at ${usage_percent}% (Threshold: ${THRESHOLD}%)"
        fi
    }

    # Infinite loop with configurable sleep interval
    while true; do
        check_ram_usage
        sleep "$INTERVAL"
    done

  entrypoint.sh: |
    #!/bin/bash
    set -e

    # Paths
    AUTOSTART_DIR="/etc/xdg/autostart"
    DESKTOP_FILE="$AUTOSTART_DIR/helios-ram-monitor.desktop"
    SCRIPT_PATH="/etc/helios/init.d/helios-ram-monitor-1/helios-ram-monitor.sh"

    # Create autostart .desktop file
    cat > "$DESKTOP_FILE" <<EOF
    [Desktop Entry]
    Encoding=UTF-8
    Version=1.0
    Type=Application
    Name=Helios RAM Monitor
    Comment=Monitor system RAM usage and send notifications when above threshold
    Exec=/bin/bash $SCRIPT_PATH
    OnlyShowIn=XFCE;
    StartupNotify=true
    Terminal=false
    Hidden=false
    EOF

    chmod +x "$SCRIPT_PATH"
    echo "Installed Helios RAM Monitor desktop autostart entry at $DESKTOP_FILE"
